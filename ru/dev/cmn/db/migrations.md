---
title: Миграции
---

# Описание

Миграции - это система версионирования структуры базы данных, 
позволяющая описать разницу структуры между двумя состояниями (двумя
релизами приложения) в виде отдельных файлов, содержащих эти изменения.

# Функционал

# Декларативные / исполняемые

# Атомарность

# Изменение данных и обновление без простоя

Миграции предназначены исключительно для изменения структуры 
приложения, и не должны каким-либо образом изменять данные - это 
нарушает сам принцип версионирования, потому что в этом случае 
результат работы миграций зависит от находящихся в БД на момент 
применения данных - миграции занимаются исключительно структурой БД,
изменением данных занимается приложение, испольюзующее БД. На первый 
взгляд может показаться, что, например, при добавлении новых колонок
проще сразу же установить значения по умолчанию, но этот подход не 
учитывает многие крайние случаи. Это можно проиллюстрировать на примере
с приложением, которое хочет добавить новую схему хэширования паролей
пользователей, и смигрировать от одной схемы таблицы пользователей

    -- table users
    id | login | hash
    1  | user  | aaaabbbbccccdddd
    
к другой

    -- table users
    id | login | hash             | hash_algorithm
    1  | user  | aaaabbbbccccdddd | md5
    2  | admin | bbbbccccddddeeee | sha512
    
проще всего в этом случае сделать следующиий набор миграций:

- Добавить столбец `hash_algorithm`
- Заполнить его значением `md5`

Однако в этом случае принцип организации миграций будет нарушен, и
появятся проблемы следующего характера:

- Корректно ли отработает приложение, если пользователь успеет обновить 
пароль послее применения миграций, но до обновления приложения?

# Инициализирующие данные

При использовании миграций может возникнуть желание использовать 
миграции для заполнения хранилища начальными данными. Этот механизм 
также идет в разрез с принципами миграций, потому что в этом случае
нельзя обеспечить идемпотентность применения изменений и отката.

# Популярные реализации

## Java

- [Liquibase][liquibase]

## PHP

- [Phinx][phinx]
- [Doctrine Migrations][doctrine-migrations]
- [Yii 2 (встроенный функционал)][yii]
- [Laravel (встроенный функционал)][laravel]
- [CodeIgniter (встроенный функционал)][codeigniter]
- [Phalcon (встроенный функционал)][phalcon]

  [liquibase]: http://www.liquibase.org/
  [phinx]: https://phinx.org/
  [doctrine-migrations]: https://github.com/doctrine/migrations
  [yii]: http://www.yiiframework.com/doc-2.0/guide-db-migrations.html
  [laravel]: https://laravel.com/docs/5.4/migrations
  [codeigniter]: https://www.codeigniter.com/user_guide/libraries/migration.html
  [phalcon]: https://docs.phalconphp.com/en/latest/reference/migrations.html